<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>Wedding Seating Plan</title>
  <meta name="color-scheme" content="light" />
  <style>
    :root{
      --bg:#fdf8f4;--card:#fff;--ink:#222;--muted:#666;--ring:#d7c7b6;--shadow:0 4px 12px rgba(0,0,0,.12)
    }
    *{box-sizing:border-box}
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple SD Gothic Neo", sans-serif;
      background:var(--bg);margin:0;padding:20px;text-align:center;color:var(--ink);
    }
    .wrap{max-width:960px;margin:0 auto}
    h1{font-size:clamp(1.25rem,2.5vw,1.8rem);margin:0 0 14px;line-height:1.35}
    p.lead{margin:0 0 16px;color:var(--muted)}
    .searchbar{display:flex;gap:8px;justify-content:center;align-items:center;margin:12px 0 10px}
    label{position:absolute;clip:rect(0 0 0 0);clip-path:inset(50%);height:1px;overflow:hidden;white-space:nowrap;width:1px}
    input[type="text"]{
      padding:12px 14px;font-size:1.1rem;width:min(90%,480px);border-radius:12px;border:1px solid #ccc;outline:none;
      box-shadow:var(--shadow);transition:border-color .15s ease;
    }
    input[type="text"]:focus{border-color:var(--ring)}

    .meta-row{display:flex;gap:10px;justify-content:center;align-items:center;font-size:.95rem;color:var(--muted);margin-bottom:6px}
    .pill{border:1px solid #e8e1d8;border-radius:999px;padding:.25rem .6rem;background:#fff}

    .result{margin-top:8px;font-size:1.05rem}
    .group{margin:10px auto;max-width:600px;text-align:left}
    .group h3{margin:14px 6px 8px;font-size:1rem;color:#7a6d60;font-weight:700}
    .guest-item{margin:8px 6px;padding:12px;border-radius:12px;background:var(--card);box-shadow:var(--shadow);display:flex;justify-content:space-between;gap:8px;align-items:center}
    .guest-item strong{color:#444}
    .seat{white-space:nowrap;color:#4e473f;font-weight:600}
    mark{background:#fff0b3;padding:0 .15em;border-radius:.2em}

    img.thumb{width:100%;max-width:640px;margin:18px auto 4px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.18);cursor:zoom-in}

    .hint{font-size:.95rem;font-style:italic;margin:4px 0 14px;font-weight:700}

    /* Lightbox */
    .lightbox{display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.85);justify-content:center;align-items:center;overflow:hidden}
    .lightbox:target{display:flex}
    .lightbox a.close{position:absolute;top:16px;right:20px;font-size:30px;color:#fff;text-decoration:none;z-index:1010}
    .stage{position:relative;width:100%;height:100%;touch-action:none}
    .stage img{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(1);will-change:transform;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.5);user-select:none;pointer-events:auto}

    @media (max-width:480px){
      input[type="text"]{font-size:1.1rem}
      .guest-item{font-size:1.05rem}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Seijin & Jiwon Wedding Seating Plan üë∞‚ù§Ô∏èü§µ</h1>
    <p class="lead">Find your table and seat. Welcome & congratulations! ‚ú®</p>

    <div class="searchbar">
      <label for="searchBox">Search your name</label>
      <input id="searchBox" type="text" inputmode="text" autocomplete="name" placeholder="Enter your name‚Ä¶" aria-controls="result" aria-autocomplete="list" aria-describedby="help" autofocus />
    </div>

    <div class="meta-row" id="help">
      <span class="pill" id="count">0 guests</span>
      <span class="pill">Tip: try first name only</span>
    </div>

    <div class="hint">*Seats arranged clockwise from the north ü™ë</div>

    <!-- Floorplan thumbnail -->
    <a href="#floorplan"><img class="thumb" src="Seating_Plan.jpg" alt="Wedding floor plan preview"></a>

    <!-- Results region -->
    <div id="result" class="result" aria-live="polite"></div>
  </div>

  <!-- Lightbox -->
  <div id="floorplan" class="lightbox" role="dialog" aria-modal="true" aria-label="Floor plan zoom">
    <a class="close" href="#" aria-label="Close">‚úï</a>
    <div class="stage">
      <img id="zoomImg" src="Seating_Plan.jpg" alt="Wedding floor plan large">
    </div>
  </div>

  <script src="data/guests.js"></script>
  <script>
    const guests = window.GUESTS || [];


// --- Utilities ------------------------------------------------------
const $ = sel => document.querySelector(sel);
const resultDiv = $('#result');
const countPill = $('#count');
const box = $('#searchBox');

// Normalize text (case/diacritics/extra spaces)
const norm = s => (s||"")
  .toLowerCase()
  .normalize('NFKD')
  .replace(/[\u0300-\u036f]/g, '') // strip accents
  .replace(/\s+/g,' ')              // collapse spaces
  .trim();

// Simple Levenshtein distance (capped for speed)
function editDistance(a,b,max=2){
  if(Math.abs(a.length-b.length)>max) return max+1;
  const dp = new Array(b.length+1);
  for(let j=0;j<=b.length;j++) dp[j]=j;
  for(let i=1;i<=a.length;i++){
    let prev = i-1; dp[0]=i;
    for(let j=1;j<=b.length;j++){
      const tmp = dp[j];
      dp[j] = a[i-1]===b[j-1]? prev : 1+Math.min(prev, dp[j], dp[j-1]);
      prev = tmp;
    }
  }
  return dp[b.length];
}

// Highlight matched substring
function highlight(name, query){
  const n = name; const q = query;
  const idx = n.toLowerCase().indexOf(q.toLowerCase());
  if(idx<0) return n;
  return n.slice(0,idx)+'<mark>'+n.slice(idx, idx+q.length)+'</mark>'+n.slice(idx+q.length);
}

// Group by table number
function groupByTable(list){
  const map = new Map();
  for(const g of list){
    const key = g.table;
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(g);
  }
  // sort tables by number at the end of the string
  return [...map.entries()].sort((a,b)=>{
    const an = parseInt(a[0].match(/(\d+)/)?.[1]||'0',10);
    const bn = parseInt(b[0].match(/(\d+)/)?.[1]||'0',10);
    return an-bn;
  });
}

// Debounce
function debounce(fn, wait=120){
  let t;return (...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),wait)}
}

// Update count pill
countPill.textContent = `${guests.length} guests`;

// --- Search ---------------------------------------------------------
function searchGuest(){
  const q = norm(box.value);
  if(!q){ resultDiv.innerHTML=''; return; }

  // scoring: 0 exact, 1 starts-with token, 2 includes, 3 fuzzy (<=2 edits)
  const scored = guests.map(g=>{
    const nameN = norm(g.name);
    let score = Infinity;
    if(nameN===q) score=0;
    else if(nameN.startsWith(q) || nameN.split(' ').some(t=>t.startsWith(q))) score=1;
    else if(nameN.includes(q)) score=2;
    else if(editDistance(nameN, q, 2)<=2) score=3;
    return { ...g, score };
  }).filter(x=>x.score!==Infinity)
    .sort((a,b)=> a.score-b.score || a.name.localeCompare(b.name));

  if(scored.length===0){
    resultDiv.innerHTML = `<span style="color:#cc0000">No matching names found.</span>`;
    return;
  }

  const grouped = groupByTable(scored);
  const qRaw = box.value.trim();
  const html = grouped.map(([table, items])=>{
    const itemsHtml = items.map(g=>
      `<div class="guest-item"><strong>${highlight(g.name, qRaw)}</strong><span class="seat">üçΩÔ∏è ${g.table}, ü™ë ${g.seat}</span></div>`
    ).join('');
    return `<div class="group"><h3>${table}</h3>${itemsHtml}</div>`;
  }).join('');

  resultDiv.innerHTML = html;
}

box.addEventListener('input', debounce(searchGuest, 120));

// Support prefill via URL ?q=Name
(function initFromURL(){
  const params = new URLSearchParams(location.search);
  const q = params.get('q');
  if(q){ box.value = q; searchGuest(); box.focus(); box.select(); }
})();

// Keep URL in sync (without reload)
(function syncURL(){
  let last = '';
  box.addEventListener('input', debounce(()=>{
    const v = box.value.trim();
    if(v===last) return; last=v;
    const url = new URL(location);
    if(v) url.searchParams.set('q', v); else url.searchParams.delete('q');
    history.replaceState({}, '', url);
  }, 200));
})();

// --- Lightbox pan & zoom (pointer + wheel) --------------------------
(function setupPanZoom(){
  const img = document.getElementById('zoomImg');
  let scale = 1, tx = 0, ty = 0, dragging = false, sx=0, sy=0;

  const apply = ()=>{
    img.style.transform = `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(${scale})`;
  };

  img.addEventListener('pointerdown', e=>{
    e.preventDefault(); dragging=true; img.setPointerCapture(e.pointerId);
    sx = e.clientX; sy = e.clientY; img.style.cursor='grabbing';
  });
  img.addEventListener('pointermove', e=>{
    if(!dragging) return; tx += (e.clientX - sx); ty += (e.clientY - sy); sx=e.clientX; sy=e.clientY; apply();
  });
  const stop = ()=>{ dragging=false; img.style.cursor='grab'; };
  img.addEventListener('pointerup', stop); img.addEventListener('pointercancel', stop); img.addEventListener('pointerleave', stop);

  // Wheel to zoom (desktop)
  img.addEventListener('wheel', e=>{
    e.preventDefault(); const delta = -Math.sign(e.deltaY) * 0.1; const next = Math.min(4, Math.max(1, scale + delta));
    if(next!==scale){
      // zoom towards cursor
      const rect = img.getBoundingClientRect();
      const cx = e.clientX - rect.left - rect.width/2; // relative to center
      const cy = e.clientY - rect.top - rect.height/2;
      tx -= cx * (next/scale - 1);
      ty -= cy * (next/scale - 1);
      scale = next; apply();
    }
  }, { passive:false });

  // Double-click to toggle zoom
  img.addEventListener('dblclick', e=>{
    e.preventDefault(); if(scale===1){ scale=2; } else { scale=1; tx=ty=0; } apply();
  });

  // Reset when closing lightbox
  window.addEventListener('hashchange', ()=>{
    if(location.hash !== '#floorplan'){ scale=1; tx=ty=0; apply(); }
  });

  apply();
})();
</script>
</body>
</html>
